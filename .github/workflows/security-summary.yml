name: Security Summary

on:
  # Запускать ТОЛЬКО после окончания Security Gateway
  workflow_run:
    workflows: ["Security Gateway"]
    types: [completed]

  # Ручной запуск из Actions (удобно для тестов)
  workflow_dispatch:

permissions:
  actions: read
  checks: read
  contents: read
  pull-requests: write   # пишем комментарий в PR

concurrency:
  # один прогон на один и тот же коммит
  group: security-summary-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

jobs:
  summarize:
    # бежим только если Gateway завершился УСПЕШНО
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Build summary & comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const sha   = context.payload.workflow_run.head_sha;

            const required = [
              "SAST - CodeQL",
              "SAST - Semgrep",
              "Lint - ESLint",
              "Dependency Audit",
              "Secrets Scan - Gitleaks",
              "DAST - OWASP ZAP Baseline",
              "Lint - GitHub Actions",
              "CI - Build & Test",
              "Security Gateway"
            ];

            const { data } = await github.rest.actions.listWorkflowRunsForRepo({
              owner, repo, per_page: 100, head_sha: sha
            });

            const latest = {};
            for (const r of data.workflow_runs) {
              if (!required.includes(r.name)) continue;
              if (!latest[r.name]) latest[r.name] = r.conclusion; // первый — самый свежий
            }

            const rows = required.map(n => `| ${n} | ${latest[n] ?? "—"} |`).join("\n");
            const body = [
              "### Security Summary",
              "",
              "| Проверка | Статус |",
              "|---|---|",
              rows
            ].join("\n");

            const prNumber = context.payload.workflow_run?.pull_requests?.[0]?.number;
            if (prNumber) {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
            } else {
              core.notice("PR not found for this run; printed to logs only.");
              console.log(body);
            }
