name: Security Summary

on:
  workflow_run:
    workflows: ["Security Gateway"]
    types: [completed]

jobs:
  summarize:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
      actions: read
    steps:
      - name: Build markdown summary & publish
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const sha   = context.payload.workflow_run.head_sha;

            const required = [
              "SAST - CodeQL",
              "SAST - Semgrep",
              "Lint - ESLint",
              "Dependency Audit",
              "Secrets Scan - Gitleaks",
              "DAST - OWASP ZAP Baseline",
              "Lint - GitHub Actions",
              "CI - Build & Test",
              "Node CI"
            ];

            // Забираем завершенные рансы для этого коммита
            const { data } = await github.rest.actions.listWorkflowRunsForRepo({
              owner, repo, per_page: 100, head_sha: sha, status: 'completed'
            });

            const latest = {};
            for (const r of data.workflow_runs) {
              if (!required.includes(r.name)) continue;
              if (!latest[r.name]) latest[r.name] = r.conclusion;
            }

            function badge(c) {
              return c === 'success' ? '✅' :
                     c === 'failure' ? '❌' :
                     c === 'cancelled' ? '⏹️' : '⚠️';
            }

            let ok = true;
            const lines = required.map(n => {
              const c = latest[n] || 'missing';
              if (c !== 'success') ok = false;
              return `- ${badge(c)} **${n}** — \`${c}\``;
            });

            const md = [
              `### Security Summary for \`${sha.slice(0,7)}\``,
              '',
              ...lines,
              '',
              ok ? '**Overall:** ✅ All required checks passed.' :
                   '**Overall:** ❌ Some checks failed or missing.'
            ].join('\n');

            // Комментарий в PR (если есть связанный PR)
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({ owner, repo, commit_sha: sha });
            if (prs.data.length) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: prs.data[0].number, body: md
              });
            }

            // Check Run «Security Summary»
            await github.rest.checks.create({
              owner, repo,
              name: 'Security Summary',
              head_sha: sha,
              status: 'completed',
              conclusion: ok ? 'success' : 'failure',
              output: { title: 'Security Summary', summary: md }
            });
