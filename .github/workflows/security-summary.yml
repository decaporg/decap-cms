name: Security Summary

on:
  pull_request:
    types: [opened, synchronize, reopened]   # –ø—Ä–∏ –ª—é–±–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ PR

permissions:
  pull-requests: write        # —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR
  actions: read               # —á—Ç–æ–±—ã —á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –¥—Ä—É–≥–∏—Ö workflow
  contents: read

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - name: –°–æ–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –ø–æ—Å—á–∏—Ç–∞—Ç—å –æ—Ü–µ–Ω–∫—É
        id: build
        uses: actions/github-script@v7
        with:
          script: |
            // –ö–∞–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—á–∏—Ç–∞–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏
            const required = [
              "SAST - CodeQL",
              "SAST - Semgrep",
              "Lint - ESLint",
              "Dependency Audit",
              "Secrets Scan - Gitleaks",
              "DAST - OWASP ZAP Baseline",
              "Lint - GitHub Actions",
              "CI - Build & Test"
            ];

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞–Ω—Å—ã workflow –ø–æ —Å–æ–±—ã—Ç–∏—é pull_request
            const { data } = await github.actions.listWorkflowRunsForRepo({
              owner, repo, per_page: 100, event: "pull_request"
            });

            const latest = {};
            for (const r of data.workflow_runs) {
              if (!required.includes(r.name)) continue;
              // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—ã–π –≤—Å—Ç—Ä–µ—á–µ–Ω–Ω—ã–π –∫–∞–∫ —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π
              if (!latest[r.name]) latest[r.name] = r;
            }

            let ok = 0;
            const lines = ["| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –°—Ç–∞—Ç—É—Å |", "|---|---|"];
            for (const name of required) {
              const r = latest[name];
              const status = r ? (r.conclusion || r.status) : "missing";
              const emoji = status === "success" ? "‚úÖ"
                          : status === "failure" ? "‚ùå"
                          : status === "cancelled" ? "üö´"
                          : "‚è≥";
              if (status === "success") ok++;
              lines.push(`| ${name} | ${emoji} ${status} |`);
            }
            const score = Math.round((ok / required.length) * 100);

            core.setOutput("table", lines.join("\n"));
            core.setOutput("score", String(score));

      - name: –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É –≤ PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: security-summary
          message: |
            ## –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫: **${{ steps.build.outputs.score }}%**

            ${{ steps.build.outputs.table }}
