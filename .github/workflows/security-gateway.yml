name: Security Gateway

on:
  workflow_run:
    workflows:
      - "SAST - CodeQL"
      - "SAST - Semgrep"
      - "Lint - ESLint"
      - "Dependency Audit"
      - "Secrets Scan - Gitleaks"
      - "DAST - OWASP ZAP Baseline"
      - "Lint - GitHub Actions"
      - "CI - Build & Test"           # если есть сборка — пусть она будет «последней»
    types: [completed]

# ➜ один запуск на один и тот же коммит; предыдущие — отменяем
concurrency:
  group: security-gateway-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  checks: read
  pull-requests: write

jobs:
  gate:
    # запускать только если завершившийся workflow сам не упал
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate required checks for the same commit
        uses: actions/github-script@v7
        with:
          script: |
            const required = [
              "SAST - CodeQL",
              "SAST - Semgrep",
              "Lint - ESLint",
              "Dependency Audit",
              "Secrets Scan - Gitleaks",
              "DAST - OWASP ZAP Baseline",
              "Lint - GitHub Actions",
              "CI - Build & Test"
            ];

            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const sha   = context.payload.workflow_run.head_sha; // ← ключевой момент

            // Берём последние запуски ИМЕННО на этот коммит (head_sha)
            const { data } = await github.actions.listWorkflowRunsForRepo({
              owner, repo, per_page: 100, head_sha: sha
            });

            const latest = {};
            for (const r of data.workflow_runs) {
              if (!required.includes(r.name)) continue;
              if (!latest[r.name]) latest[r.name] = r.conclusion; // первый в списке — самый свежий
            }

            const missing = required.filter(n => latest[n] === undefined);
            const failed  = Object.entries(latest)
                                  .filter(([_, c]) => c !== "success")
                                  .map(([n, c]) => `${n}=${c}`);

            if (missing.length) {
              core.setFailed(`Missing runs for this commit: ${missing.join(", ")}`);
              return;
            }
            if (failed.length) {
              core.setFailed(`Failed checks for this commit: ${failed.join(", ")}`);
              return;
            }

            core.info(`Security gate passed ✅ for ${sha.substring(0,7)}`);
